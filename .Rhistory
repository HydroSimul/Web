fill = "grey86",
size = 4
) +
geom_spatvector(
data = vct_Point_Unknow,
aes(fill = num_IDW, shape = "Unknow"),
color = color_RUB_blue,
size = 6
) +
geom_spatvector(
data = vct_Segment_S10[idx_Near5],
color = color_TUD_orange,
alpha = 0.8
) +
geom_spatvector_label(
data = vct_Segment_S10[idx_Near5] |> centroids(),
aes(label = num_IDW_Weight),
color = color_TUD_orange
) +
scale_fill_gradientn(
"Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(700, 1450)
) +
scale_shape_manual(values = c(Gauge = 24, Unknow = 21)) +
ggtitle('Inverse Distance Weighting (IDW)') +
coord_sf(expand = FALSE) +
theme(
axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = 0.5)
)
#| echo: false
df_Station <- data.frame(
geom(vct_Station_NRW_S50)[, c("x", "y")],
as.data.frame(vct_Station_NRW_S50)
)
## Variogram -------
model_Vario <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station
)
vario_S50 <- variogram(model_Vario, width = 0.05)
psill  <- 6e4
range  <- .5
nugget <- 3e3
fit_Sph <- fit.variogram(vario_S50, vgm(psill, "Sph", range, nugget))
coord_S50 <- crds(vct_Station_NRW_S50)
# Create all pairwise combinations
n_points <- nrow(coord_S50)
combinations <- combn(1:n_points, 2)
# Create segments for each pair
coord_AllSegment <- lapply(1:ncol(combinations), \(i) {
idx1 <- combinations[1, i]
idx2 <- combinations[2, i]
rbind(coord_S50[idx1, ], coord_S50[idx2, ])
})
vct_AllSegment_S50 <- vect(coord_AllSegment, type = "lines", crs = crs(vct_Point_Unknow))
vct_AllSegment_S50$length_km <- perim(vct_AllSegment_S50) / 1000
df_Cuver_Fit <- variogramLine(fit_Sph, maxdist = max(vario_S50$dist))
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| echo: false
gp_Seg <- ggplot() +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
geom_spatvector(data = vct_Station_NRW_S50, shape = 17, color = color_RUB_blue,
size = 4) +
geom_spatvector(
data = vct_AllSegment_S50,
aes(color = length_km),
alpha = .8
) +
scale_color_gradientn("Distance h (km)",
colors = color_DRESDEN) +
ggtitle('Mean Annual Precipitation (1981–2010) at 10 Gauges') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
color = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
gp_Fit <- ggplot() +
geom_point(data = vario_S50, aes(x = dist, y = gamma, color = dist), size = 3) +
geom_line(data = df_Cuver_Fit, aes(x = dist, y = gamma),
color = color_TUD_orange, linewidth = 1) +
scale_color_gradientn("Distance h (°)",
colors = color_DRESDEN) +
labs(x = "Diistance (°)", y = "Semivariance")  +
theme(
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
color = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
(gp_Seg | gp_Fit)
#| fig-fullwidth: true
#| fig-width: 10
#| fig-height: 6.5
#| echo: false
# Create general variogram models with typical parameters
model_varioGenaral <- list(
Exponential = vgm(psill = 1, "Exp", range = 1, nugget = 0.1),
Spherical = vgm(psill = 1, "Sph", range = 1, nugget = 0.1),
Circular = vgm(psill = 1, "Cir", range = 1, nugget = 0.1),
Gaussian = vgm(psill = 1, "Gau", range = 1, nugget = 0.1),
Linear = vgm(psill = 1, "Lin", range = 1, nugget = 0.1),
Matern = vgm(psill = 1, "Mat", range = 1, nugget = 0.1, kappa = 1)
)
# Generate curves for all models
df_varioGenaral <- data.frame()
for (model_name in names(model_varioGenaral)) {
df_model <- variogramLine(model_varioGenaral[[model_name]], maxdist = 2, n = 100)
df_model$model <- model_name
df_varioGenaral <- rbind(df_varioGenaral, df_model)
}
# Convert to factor for proper ordering
df_varioGenaral$model <- factor(df_varioGenaral$model,
levels = c("Exponential", "Spherical", "Circular",
"Gaussian", "Linear", "Matern"))
# Plot
ggplot(df_varioGenaral, aes(x = dist, y = gamma)) +
geom_line(color = color_RUB_green, linewidth = 1) +
facet_wrap(~model, ncol = 3, scales = "fixed") +
labs(x = "Distance", y = "Semivariance",
title = "General Variogram Model Shapes") +
theme(
axis.text.y = element_text(angle = 90, hjust = 0.5)
)
ggplot() +
geom_spatvector(data = vct_Station_NRW_S50, aes(fill = NiederschlagJahr),
shape = 24, size = 4) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('Mean Annual Precipitation (1981–2010)') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5))
rst_Template_NRW <- rast(vct_Boundry_NRW, res = 0.01)
values(rst_Template_NRW) <- 1
rst_Template_NRW <-  mask(rst_Template_NRW, vct_Boundry_NRW)
# Convert station SpatVector to a data.frame with coordinates
df_Station_NRW_S50 <- data.frame(geom(vct_Station_NRW_S50)[, c("x", "y")],
as.data.frame(vct_Station_NRW_S50))
model_Near1 <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station_NRW_S50,
nmax = 1,
set = list(idp = 0)
)
# Interpolate on raster grid
rst_Near1 <- interpolate(rst_Template_NRW, model_Near1, debug.level = 0) |>
mask(vct_Boundry_NRW)
vct_Voronoi_NRW_S50 <- voronoi(vct_Station_NRW_S50) |> crop(vct_Boundry_NRW)
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| code-fold: true
gp_Near1 <- ggplot() +
geom_spatraster(data = rst_Near1, aes(fill = var1.pred)) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('Nearest Neighbor (1-nearest)') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
gp_Voronoi_NRW_S50 <- ggplot() +
geom_spatvector(data = vct_Voronoi_NRW_S50, aes(fill = NiederschlagJahr)) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('Thiessen Polygons') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
(gp_Near1 | gp_Voronoi_NRW_S50)
model_Near5 <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station_NRW_S50,
nmax = 5,
set = list(idp = 0)
)
# Interpolate on raster grid
rst_Near5 <- interpolate(rst_Template_NRW, model_Near5, debug.level = 0) |>
mask(vct_Boundry_NRW)
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| code-fold: true
gp_Near5 <- ggplot() +
geom_spatraster(data = rst_Near5, aes(fill = var1.pred)) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
geom_spatvector(data = vct_Station_NRW_S50, aes(fill = NiederschlagJahr),
shape = 24, size = 3, color = "grey96", linewidth = 1) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('k-Nearest Neighbors') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
(gp_Near1 | gp_Near5)
model_IDW <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station_NRW_S50,
nmax = 5
)
rst_IDW <- interpolate(rst_Template_NRW, model_IDW, debug.level = 0) |>
mask(vct_Boundry_NRW)
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| code-fold: true
gp_IDW <- ggplot() +
geom_spatraster(data = rst_IDW, aes(fill = var1.pred)) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('Inverse Distance Weighting (IDW)') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
(gp_Near5 | gp_IDW)
# Define combinations of neighbors (nmax) and power (idp)
lst_IDW_Params <- list(
k5p1  = list(nmax = 5, idp = 1),
k10p1 = list(nmax = 10, idp = 1),
k5p3  = list(nmax = 5, idp = 3),
k10p3 = list(nmax = 10, idp = 3)
)
# Function to create IDW raster
create_idw <- function(nmax, idp) {
model <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station_NRW_S50,
nmax = nmax,
set = list(idp = idp)
)
interpolate(rst_Template_NRW, model, debug.level = 0) |> mask(vct_Boundry_NRW)
}
# Generate all four rasters
lst_rst_IDW <- lapply(lst_IDW_Params, \(p) create_idw(p$nmax, p$idp))
#| code-fold: true
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 13
rst_IDW_combined <- rast(lst_rst_IDW)
rst_IDW_combined <- rst_IDW_combined[[c(1, 3, 5, 7)]]
# Set layer names to match parameter combinations
names(rst_IDW_combined) <- c("k=5, p=1", "k=10, p=1", "k=5, p=3", "k=10, p=3")
# Create facet plot
ggplot() +
geom_spatraster(data = rst_IDW_combined) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
facet_wrap(~lyr, ncol = 2) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
coord_sf(expand = FALSE) +
labs(title = "Inverse Distance Weighting (IDW) - Parameter Comparison") +
theme(
axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = 0.5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top",
strip.text = element_text(size = 10, face = "bold")
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
model_Vario <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station_NRW_S50
)
vario_S50 <- variogram(model_Vario, width = 0.05)
name_VarioModel <- c("Exp", "Sph", "Cir", "Gau", "Lin", "Mat")
names(name_VarioModel) <- name_VarioModel
psill  <- 6e4
range  <- 0.5
nugget <- 3e3
lst_FitVario <- map(name_VarioModel[-6], \(m_Vario) fit.variogram(vario_S50, vgm(psill, m_Vario, range, nugget)))
lst_FitVario$Mat <- fit.variogram(vario_S50, vgm(psill, "Mat", range, nugget, kappa=.9))
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| code-fold: true
lst_df_VarioLine <- map(lst_FitVario, variogramLine, maxdist = max(vario_S50$dist))
df_VarioLine_All <- do.call(rbind, lst_df_VarioLine)
df_VarioLine_All$model <- rep(c("Exponential", "Spherical", "Circular", "Gaussian", "Linear", "Matern"), each = 200)
# Create color palette for models
model_colors <- c(
"Exponential" = color_TUD_orange,
"Spherical" = color_RUB_blue,
"Circular" = color_TUD_lightblue,
"Gaussian" = color_RUB_green,
"Linear" = color_TUD_pink,
"Matern" = color_TUD_redpurple
)
# Determine the y-axis range from your data
y_range <- range(vario_S50$gamma, df_VarioLine_All$gamma, na.rm = TRUE)
gp_Fit <- ggplot() +
geom_point(data = vario_S50, aes(x = dist, y = gamma), size = 3, shape = 1, color = color_RUB_blue) +
geom_line(data = df_VarioLine_All, aes(x = dist, y = gamma, color = model), linewidth = 1) +
scale_color_manual("Model", values = model_colors) +
labs(x = "Distance (°)", y = NULL) +  # Remove y-axis title
lims(y = y_range) +  # Same y-axis range
theme(
axis.text.y = element_blank(),  # Remove y-axis text
axis.ticks.y = element_blank(), # Remove y-axis ticks
legend.position = "inside",
legend.justification = c("right", "bottom"),
legend.position.inside = c(0.99, 0.01)
)
gp_Scatter <- ggplot() +
geom_point(data = vario_S50, aes(x = dist, y = gamma, color = dist), size = 3) +
scale_color_gradientn("Distance h (°)", colors = color_DRESDEN) +
labs(x = "Distance (°)", y = "Semivariance") +
lims(y = y_range) +
theme(
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
color = guide_colorbar(barwidth = 8, barheight = 0.6)
)
# Combine the plots
(gp_Scatter | gp_Fit) +
plot_annotation(title = "Variogram Models Comparison")
lst_RMSE_VarioFit <- map(lst_FitVario, \(m_Fit) {
cv_model <-  krige.cv(NiederschlagJahr ~ 1, locations = ~x + y, data = df_Station, model = m_Fit)
obs <- cv_model$observed
pred <- cv_model$var1.pred
sqrt(mean((obs - pred)^2, na.rm = TRUE))
})
print(lst_RMSE_VarioFit |> unlist())
model_OK <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station,
model = lst_FitVario$Sph,
namx = 5
)
model_OK <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station,
model = lst_FitVario$Sph,
nmax = 5
)
rst_OK <- interpolate(rst_Template_NRW, model_OK, debug.level = 0) |>
mask(vct_Boundry_NRW)
lst_rst_OK_VarioModel <- map(lst_FitVario, \(m_OK) {
model_OK <- gstat(
formula = NiederschlagJahr ~ 1,
locations = ~x + y,
data = df_Station,
model = lst_FitVario$Sph
)
interpolate(rst_Template_NRW, model_OK, debug.level = 0) |>
mask(vct_Boundry_NRW)
})
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| code-fold: true
gp_OK <- ggplot() +
geom_spatraster(data = rst_OK, aes(fill = var1.pred)) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('Ordinary Kriging with Spherical Variogramm') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
(gp_IDW | gp_OK)
#| fig-fullwidth: true
#| fig-width: 12
#| fig-height: 6.5
#| code-fold: true
gp_OK <- ggplot() +
geom_spatraster(data = rst_OK, aes(fill = var1.pred)) +
geom_spatvector(data = vct_Boundry_NRW, color = color_TUD_pink, fill = NA) +
geom_spatvector(data = vct_Station_NRW_S50, aes(fill = NiederschlagJahr),
shape = 24, size = 3, color = "grey96", linewidth = 1) +
scale_fill_gradientn("Value",
colors = color_DRESDEN,
na.value = "transparent",
limits = c(550, 1500)) +
ggtitle('Ordinary Kriging with Spherical Variogramm') +
coord_sf(expand = FALSE) +
theme(axis.title = element_blank(),
axis.text.y = element_text(angle = 90, hjust = .5),
legend.position = "inside",
legend.position.inside = c(0.99, 0.01),
legend.justification = c("right", "bottom"),
legend.direction = "horizontal",
legend.title.position = "top"
) +
guides(
fill = guide_colorbar(
barwidth = 8,
barheight = 0.6
)
)
(gp_IDW | gp_OK)
