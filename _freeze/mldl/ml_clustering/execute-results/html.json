{
  "hash": "b8c5b6a4961753fd20b64129d84e3349",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Clustering\nexecute:\n  warning: false\n  error: false\nsidebar:\n  contents: auto\nnumber-sections: true\n---\n\n\n\n\n\n# Library and Data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidymodels)\nlibrary(tidyverse)\ntheme_set(theme_bw())\nlibrary(tidyclust)\nlibrary(embed)\n# library(cluster)\nlibrary(dbscan)\nlibrary(ggdendro)\nlibrary(patchwork)\nlibrary(ggforce)\nlibrary(reshape2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncolor_RUB_blue <- \"#17365c\"\ncolor_RUB_green <- \"#8dae10\"\ncolor_TUD_pink <- \"#EC008D\"\ncolor_DRESDEN <- c(\"#03305D\", \"#28618C\", \"#539DC5\", \"#84D1EE\", \"#009BA4\", \"#13A983\", \"#93C356\", \"#BCCF02\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_Substance <- read.csv(\"../data_share/df_2010_bafg.csv\", row.names = 1)\n```\n:::\n\n\n\n\n# EDA\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Drop rows where \"date\" is NA\ndf_Substance <- df_Substance[!is.na(df_Substance$date), ]\n\n# Print all column names\nprint(paste(\"All columns:\", paste(names(df_Substance), collapse = \", \")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"All columns: sampling_location, river, matrix, sampling_type_discharge, date, unit_discharge, less_than_discharge, discharge, substance, sampling_type_conc, unit_conc, less_than_conc, conc, sampling_type_ph, unit_ph, less_than_ph, ph, load, datetime, year, month, dayofyear, lon, lat\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Sampling locations (title case)\nunique(df_Substance$sampling_location)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"KAMPEN\"                \"BISCHOFSHEIM\"          \"KAHL AM MAIN\"         \n [4] \"KOBLENZ\"               \"PALZEM\"                \"MANNHEIM\"             \n [7] \"BAD HONNEF\"            \"BIMMEN\"                \"KARLSRUHE\"            \n[10] \"LAUTERBOURG-KARLSRUHE\" \"LOBITH\"                \"MAASSLUIS\"            \n[13] \"MAINZ\"                 \"OEHNINGEN\"             \"REKINGEN\"             \n[16] \"WEIL AM RHEIN\"         \"WORMS\"                 \"KANZEM\"               \n[19] \"SAARBRUECKEN\"          \"TREBUR-ASTHEIM\"       \n```\n\n\n:::\n\n```{.r .cell-code}\n# Rivers (title case)\nunique(df_Substance$river)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"IJSSEL\"      \"MAIN\"        \"MOSEL\"       \"NECKAR\"      \"RHEIN\"      \n[6] \"SAAR\"        \"SCHWARZBACH\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Rivers at the sampling location Koblenz\nunique(df_Substance$river[df_Substance$sampling_location == \"KOBLENZ\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"MOSEL\" \"RHEIN\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Discharge units\nunique(df_Substance$unit_discharge)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"\"     \"m³/s\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Concentration units\nunique(df_Substance$unit_conc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"µg/l\" \"\"    \n```\n\n\n:::\n\n```{.r .cell-code}\n# Substances\nunique(df_Substance$substance)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"As\" \"Pb\" \"Cd\" \"Cr\" \"K\"  \"Ca\" \"Cu\" \"Mg\" \"Na\" \"Ni\" \"P\"  \"Hg\" \"Zn\" \"\"   \"AS\"\n[16] \"B\"  \"Fe\" \"Mn\"\n```\n\n\n:::\n\n```{.r .cell-code}\ndf_Substance$substance[df_Substance$substance == \"AS\"] <- \"As\"\n\nunique(df_Substance$substance)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"As\" \"Pb\" \"Cd\" \"Cr\" \"K\"  \"Ca\" \"Cu\" \"Mg\" \"Na\" \"Ni\" \"P\"  \"Hg\" \"Zn\" \"\"   \"B\" \n[16] \"Fe\" \"Mn\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# \ndf_substances <- df_Substance[!is.na(df_Substance$conc), ]\n\nggplot(df_substances, aes(x = conc)) +\n  geom_histogram(bins = 50, color = color_RUB_blue, fill = color_RUB_green) +\n  labs(\n    x = \"Concentration (µg/L)\",\n    y = \"Count\",\n    title = \"Histogram of substance concentrations\"\n  )\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndf_substances_quant <- df_substances[df_substances$less_than_conc == \"False\", ]\nggplot(df_substances_quant, aes(x = conc)) +\n  geom_histogram(bins = 50, color = color_RUB_blue, fill = color_RUB_green) +\n  labs(\n    x = \"Concentration (µg/L)\",\n    y = \"Count\",\n    title = \"Histogram of substance concentrations\"\n  )\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n\n```{.r .cell-code}\nall_substances <- unique(df_substances_quant$substance)\ndf_iqr <- do.call(rbind, lapply(all_substances, function(substance) {\n  df_sub <- df_substances_quant[df_substances_quant$substance == substance, ]\n  q1 <- quantile(df_sub$conc, 0.25, na.rm = TRUE)\n  q3 <- quantile(df_sub$conc, 0.75, na.rm = TRUE)\n  iqr_substance <- q3 - q1\n  lower <- q1 - 1.5 * iqr_substance\n  upper <- q3 + 1.5 * iqr_substance\n  df_sub[df_sub$conc >= lower & df_sub$conc <= upper, ]\n}))\n\n\nggplot(df_iqr, aes(x = conc)) +\n  geom_histogram(bins = 50, color = color_RUB_blue, fill = color_RUB_green) +\n  labs(\n    x = \"Concentration (µg/L)\",\n    y = \"Count\",\n    title = \"Histogram of substance concentrations\"\n  )\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-4-3.png){width=672}\n:::\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\n# Create a color palette\ncolors <- scales::hue_pal()(length(all_substances))\nnames(colors) <- all_substances\n\n# Scatter plot: Discharge vs Concentration\ngp_Concen1 <- ggplot(df_iqr, aes(x = discharge, y = conc, color = substance)) +\n  geom_point(alpha = 0.7) +\n  scale_color_manual(values = colors) +\n  labs(x = \"Discharge (m³/s)\", y = \"Concentration (µg/L)\") +\n  theme(legend.position = \"right\")\n\n# Scatter plot: pH vs Concentration\ngp_Concen2 <- ggplot(df_iqr, aes(x = ph, y = conc, color = substance)) +\n  geom_point(alpha = 0.7) +\n  scale_color_manual(values = colors) +\n  labs(x = \"pH (-)\", y = NULL) +\n  theme(legend.position = \"none\")\n\n# Combine plots\ngp_Concen1 + gp_Concen2 + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-5-1.png){width=864}\n:::\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\n# Filter data\ndf_filtered <- df_iqr[df_iqr$ph > 2, ]\ndf_k <- df_filtered[df_filtered$sampling_location == \"KARLSRUHE\", ]\ndf_k_l <- df_filtered[df_filtered$sampling_location == \"LAUTERBOURG-KARLSRUHE\", ]\n\n# Create as many colors as needed\ncolors <- scales::hue_pal()(length(all_substances))\nnames(colors) <- all_substances\n\n# Plot: Karlsruhe\ngp_Karl <- ggplot(df_k, aes(x = discharge, y = conc, color = substance)) +\n  geom_point(alpha = 0.7) +\n  scale_color_manual(values = colors) +\n  labs(title = \"Karlsruhe\", x = \"Discharge (m³/s)\", y = \"Concentration (µg/L)\") +\n  theme(legend.position = \"right\") +\n  ylim(-5000, 80000)\n\n# Plot: Lauterbourg-Karlsruhe\ngp_Laut <- ggplot(df_k_l, aes(x = discharge, y = conc, color = substance)) +\n  geom_point(alpha = 0.7) +\n  scale_color_manual(values = colors) +\n  labs(title = \"Lauterbourg-Karlsruhe\", x = \"Discharge (m³/s)\") +\n  theme(legend.position = \"none\",\n        axis.text.y = element_blank(),\n        axis.title.y = element_blank()) +\n  ylim(-5000, 80000)\n\n# Combine plots\ngp_Karl + gp_Laut + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-6-1.png){width=864}\n:::\n\n```{.r .cell-code}\n# Print unique rivers\nunique(df_k$river)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] NA      \"RHEIN\"\n```\n\n\n:::\n\n```{.r .cell-code}\nunique(df_k_l$river)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] NA      \"RHEIN\"\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## Final data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_final <- df_filtered[df_filtered$sampling_location != \"KARLSRUHE\", ]\n```\n:::\n\n\n\n\n\n\n# PCA\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_PCA <- df_final\ndf_PCA <- df_PCA[df_PCA$year >= 2015, ]\n\n# Create \"site\" combining sampling_location and river\ndf_PCA$site <- paste(df_PCA$sampling_location, df_PCA$river, sep = \"_\")\n\n# Pivot to wide format with median concentrations\ndf_PCA_Summary <- df_PCA |>\n  group_by(site, substance) |>\n  summarize(conc_median = median(conc, na.rm = TRUE), .groups = \"drop\") |>\n  pivot_wider(names_from = substance, values_from = conc_median, values_fill = 0) |> \n  dplyr::select(-`NA`) |>\n  filter(site != \"NA_NA\")\n\n\nmat_PCA_Summary <- df_PCA_Summary[,-1]\ndf_PCA_Final <- t(mat_PCA_Summary) |> as.data.frame()\ncolnames(df_PCA_Final) <- df_PCA_Summary$site\n\n\nrcp_Clust <- recipe(~ ., data = df_PCA_Final |> t()) |>\n  step_normalize(all_predictors())  # normalize all columns\n\n# Prep and bake\ndf_Clust_Substance <- prep(rcp_Clust) |> bake(new_data = NULL) |> t()\ncolnames(df_Clust_Substance) <- colnames(df_PCA_Final)\nrownames(df_Clust_Substance) <- rownames(df_PCA_Final)\n\nrcp_Clust2 <- recipe(~ ., data = df_Clust_Substance) |>\n  step_normalize(all_predictors())  # normalize all columns\n\n# Prep and bake\ndf_Clust_Normal <- prep(rcp_Clust2) |> bake(new_data = NULL)\nrownames(df_Clust_Normal) <- rownames(df_PCA_Final)\n\n# Perform PCA\npca_Clust <- prcomp(df_Clust_Normal, scale. = FALSE)  # already normalized\n\n# Eigenvalues\neigen_Clust <- pca_Clust$sdev^2\n\n# Scree plot\nggplot() +\n  geom_point(aes(x = 1:length(eigen_Clust), y = eigen_Clust)) +\n  geom_hline(yintercept = 1, linetype = \"dashed\", color = color_TUD_pink) +\n  labs(x = \"PC\", y = \"Eigenvalue\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\n# Recipe for PCA on clustering data\nrcp_Clust_PCA <- recipe(~ ., data = df_Clust_Substance) |>\n  step_normalize(all_predictors()) |>  # normalize all numeric columns\n  step_pca(all_predictors(), num_comp = 3)  # keep first 4 PCs\n\n# Prep and bake\ndf_Clust_PCA <- prep(rcp_Clust_PCA) |> bake(new_data = NULL)\ndf_Clust_Plot_PCA <- df_Clust_PCA\ndf_Clust_Plot_PCA$substance <- rownames(df_Clust_Substance)\nggplot(df_Clust_Plot_PCA, aes(x = .panel_x, y = .panel_y)) +\n  geom_point(aes(shape = substance), color = color_RUB_blue) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_autodensity(alpha = 0.8, fill = color_RUB_green, color = color_RUB_blue) +\n  facet_matrix(vars(-substance), layer.diag = 2)\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-9-1.png){width=864}\n:::\n:::\n\n\n\n\n# Hierachical \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# HIERARCHICAL CLUSTERING ------------\n\nmdl_Hclust <- hier_clust(\n  num_clusters = 4,\n  linkage_method = \"complete\"  # or \"single\", \"average\", \"ward.D2\"\n) |>\n  set_engine(\"stats\")\n\n# Workflow\nwflow_Hclust <- workflow() |>\n  add_recipe(rcp_Clust_PCA) |>\n  add_model(mdl_Hclust)\n\n# Fit the model\nfit_Hclust <- fit(wflow_Hclust, data = df_Clust_Substance)\n\n# Extract cluster assignments\nclst_Hclust <- fit_Hclust |>\n  extract_cluster_assignment()\n```\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\nlabel_clst_Hclust <- clst_Hclust$.cluster\nnames(label_clst_Hclust) <- rownames(df_Clust_Substance)\nmat_Dist <- dist(df_Clust_PCA)\ndf_Hc <- hclust(mat_Dist, method = \"complete\")\n# Set labels (same order as df_Clust_Substance)\ndf_Hc$labels <- rownames(df_Clust_Substance)\n# Convert to dendro format\ndend_Data <- as.dendrogram(df_Hc) |> dendro_data()\ndf_clst_Match <- tibble(\n  label = dend_Data$labels$label,\n  cluster = label_clst_Hclust[dend_Data$labels$label]\n)\n\n# Join segment → label → cluster\ndf_Segment_Hclst <- dend_Data$segments %>%\n  left_join(dend_Data$labels %>% select(label, x), by = \"x\") %>%\n  left_join(df_clst_Match, by = \"label\")\n\n# Fill NA cluster values upward in tree\ndf_Segment_Hclst$cluster <- zoo::na.locf(df_Segment_Hclst$cluster, fromLast = TRUE)\n\nggplot() +\n  geom_segment(data = df_Segment_Hclst,\n               aes(x = x, y = y, xend = xend, yend = yend,\n                   color = factor(cluster)),\n               linewidth = 0.7) +\n  geom_text(data = dend_Data$labels,\n            aes(x = x, y = y, label = label),\n            hjust = 1, angle = 90, size = 3) +\n  labs(title = \"Dendrogram (Complete Linkage)\",\n       x = \"\", y = \"Height\", color = \"Cluster\") +\n  theme(axis.text.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        panel.grid = element_blank())\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-11-1.png){width=864}\n:::\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\ndf_Hclust_Plot <- cbind(df_Clust_Plot_PCA, clst_Hclust)\n# Scatter plot: PC1 vs PC2\ngp_Hclust1 <- ggplot(df_Hclust_Plot, aes(x = PC2, y = PC1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_mark_ellipse(aes(x = PC2, y = PC1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"PC2\", y = \"PC1\")\n\n# Scatter plot: PC1 vs PC3\ngp_Hclust2 <- ggplot(df_Hclust_Plot, aes(x = PC3, y = PC1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_mark_ellipse(aes(x = PC3, y = PC1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"PC3\", y = \"PC1\")\ngp_Hclust1 + (gp_Hclust2 + theme(axis.text.y = element_blank(),\n                                 axis.title.y = element_blank())) + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-12-1.png){width=864}\n:::\n:::\n\n\n\n\n\n# K-Means\n\n\n## k test\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_Kmeans_Elbow <- tibble(k = 2:8, wss_value = NA)\ndf_Kmeans_Silhouette <- tibble(\n  k = 2:8, \n  avg_silhouette = NA\n)\n\nfor (i in 2:8) {\n  set.seed(123)\n  fit_Temp <- workflow() |>\n    add_recipe(rcp_Clust_PCA) |>\n    add_model(k_means(num_clusters = i) |> set_engine(\"stats\")) |>\n    fit(data = df_Clust_Substance)\n  \n  df_Kmeans_Elbow$wss_value[df_Kmeans_Elbow$k == i] <- fit_Temp |> \n    extract_fit_engine() |> \n    pluck(\"tot.withinss\")\n  \n\n  clusters <- fit_Temp |> extract_cluster_assignment()\n  # Prepare PCA data\n\n  # Calculate silhouette scores\n  sil <- cluster::silhouette(as.numeric(clusters$.cluster), dist(df_Clust_PCA))\n  \n  # Store average silhouette width\n  df_Kmeans_Silhouette$avg_silhouette[df_Kmeans_Silhouette$k == i] <- \n    mean(sil[, 3])\n  \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot elbow curve\nggplot(df_Kmeans_Elbow, aes(x = k, y = wss_value)) +\n  geom_line(color = color_RUB_blue) +\n  geom_point(color = color_RUB_green) +\n  labs(title = \"Elbow Method\", \n       x = \"Number of Clusters (k)\", \n       y = \"Inertia (Within-Cluster Sum of Squares)\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df_Kmeans_Silhouette, aes(x = k, y = avg_silhouette)) +\n  geom_line(color = color_RUB_blue) +\n  geom_point(color = color_RUB_green) +\n  labs(\n    title = \"Average Silhouette Score\",\n    x = \"Number of Clusters (k)\",\n    y = \"Average Silhouette Width\"\n  )\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model specification\nmdl_Kmeans <- k_means(num_clusters = 4)\n\n# Workflow\nwflow_Kmeans <- workflow() |>\n  add_recipe(rcp_Clust_PCA) |>\n  add_model(mdl_Kmeans)\n\n# Fit the model\nfit_Kmeans <- fit(wflow_Kmeans, data = df_Clust_Substance)\nfit_Kmeans$fit\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$actions\n$actions$model\n$spec\nK Means Cluster Specification (partition)\n\nMain Arguments:\n  num_clusters = 4\n\nComputational engine: stats \n\n\n$formula\nNULL\n\nattr(,\"class\")\n[1] \"action_model\" \"action_fit\"   \"action\"      \n\n\n$fit\ntidyclust cluster object\n\nK-means clustering with 4 clusters of sizes 4, 7, 2, 3\n\nCluster means:\n        PC1       PC2       PC3\n4  2.006725 -1.106215 -1.226535\n1 -1.419340 -0.971521  1.020376\n3 -2.595506  1.650320 -3.148342\n2  2.366497  2.641622  1.353397\n\nClustering vector:\n [1] 1 2 2 2 1 3 2 2 3 2 2 1 1 4 4 4\n\nWithin cluster sum of squares by cluster:\n[1]  8.321554 21.836762  1.931344 10.228733\n (between_SS / total_SS =  76.4 %)\n\nAvailable components:\n\n[1] \"cluster\"      \"centers\"      \"totss\"        \"withinss\"     \"tot.withinss\"\n[6] \"betweenss\"    \"size\"         \"iter\"         \"ifault\"      \n\nattr(,\"class\")\n[1] \"stage_fit\" \"stage\"    \n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract cluster assignments\nclst_Kmeans <- fit_Kmeans |>\n  extract_cluster_assignment()\nclst_Kmeans_Centroids <- fit_Kmeans |> extract_centroids()\n```\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\ndf_Kmeans_Plot <- cbind(df_Clust_Plot_PCA, clst_Kmeans)\n# Scatter plot: PC1 vs PC2\ngp_Kmeans1 <- ggplot(df_Kmeans_Plot, aes(x = PC2, y = PC1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_point(data = clst_Kmeans_Centroids, \n             aes(x = PC2, y = PC1, color = .cluster), \n             shape = \"X\", size = 4) +\n  geom_mark_ellipse(aes(x = PC2, y = PC1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"PC2\", y = \"PC1\")\n\n# Scatter plot: PC1 vs PC3\ngp_Kmeans2 <- ggplot(df_Kmeans_Plot, aes(x = PC3, y = PC1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_point(data = clst_Kmeans_Centroids, \n             aes(x = PC3, y = PC1, color = .cluster), \n             shape = \"X\", size = 4) +\n  geom_mark_ellipse(aes(x = PC3, y = PC1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"PC3\", y = \"PC1\")\ngp_Kmeans1 + (gp_Kmeans2 + theme(axis.text.y = element_blank(),\n                                 axis.title.y = element_blank())) + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-17-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n# DBSCAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# dbscan -----------\n\nfit_DBSCAN <- dbscan(df_Clust_PCA, eps = 2, minPts = 2)\nclst_DBSCAN <- paste0(\"Cluster_\", fit_DBSCAN$cluster)\nclst_DBSCAN[clst_DBSCAN == \"Cluster_0\"] <- NA\n```\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\ndf_DBSCAN_Plot <- cbind(df_Clust_Plot_PCA, .cluster = clst_DBSCAN)\n# Scatter plot: PC1 vs PC2\ngp_DBSCAN1 <- ggplot(df_DBSCAN_Plot, aes(x = PC2, y = PC1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_mark_ellipse(aes(x = PC2, y = PC1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"PC2\", y = \"PC1\")\n\n# Scatter plot: PC1 vs PC3\ngp_DBSCAN2 <- ggplot(df_DBSCAN_Plot, aes(x = PC3, y = PC1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_PCA$substance))) +\n  geom_mark_ellipse(aes(x = PC3, y = PC1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"PC3\", y = \"PC1\")\ngp_DBSCAN1 + (gp_DBSCAN2 + theme(axis.text.y = element_blank(),\n                                 axis.title.y = element_blank())) + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-19-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n# UMAP\n\n\n\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\n# Recipe for UMAP on clustering data\nset.seed(42)\nrcp_Clust_UMAP <- recipe(~ ., data = df_Clust_Substance) |>\n  step_normalize(all_predictors()) |>  # normalize all numeric columns\n  step_umap(all_predictors(), num_comp = 3)  # keep first 4 PCs\n\n# Prep and bake\ndf_Clust_UMAP <- prep(rcp_Clust_UMAP) |> bake(new_data = NULL)\ndf_Clust_Plot_UMAP <- df_Clust_UMAP\ndf_Clust_Plot_UMAP$substance <- rownames(df_Clust_Substance)\nggplot(df_Clust_Plot_UMAP, aes(x = .panel_x, y = .panel_y)) +\n  geom_point(aes(shape = substance), color = color_RUB_blue) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_autodensity(alpha = 0.8, fill = color_RUB_green, color = color_RUB_blue) +\n  facet_matrix(vars(-substance), layer.diag = 2)\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-20-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n# Hierachical \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# HIERARCHICAL CLUSTERING ------------\n\nmdl_Hclust <- hier_clust(\n  num_clusters = 4,\n  linkage_method = \"complete\"  # or \"single\", \"average\", \"ward.D2\"\n) |>\n  set_engine(\"stats\")\n\n# Workflow\nwflow_Hclust_UMAP <- workflow() |>\n  add_recipe(rcp_Clust_UMAP) |>\n  add_model(mdl_Hclust)\n\n# Fit the model\nfit_Hclust_UMAP <- fit(wflow_Hclust_UMAP, data = df_Clust_Substance)\n\n# Extract cluster assignments\nclst_Hclust_UMAP <- fit_Hclust_UMAP |>\n  extract_cluster_assignment()\n```\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\nlabel_clst_Hclust_UMAP <- clst_Hclust_UMAP$.cluster\nnames(label_clst_Hclust_UMAP) <- rownames(df_Clust_Substance)\nmat_Dist_UMAP <- dist(df_Clust_UMAP)\ndf_Hc_UMAP <- hclust(mat_Dist_UMAP, method = \"complete\")\n# Set labels (same order as df_Clust_Substance)\ndf_Hc_UMAP$labels <- rownames(df_Clust_Substance)\n# Convert to dendro format\ndend_Data_UMAP <- as.dendrogram(df_Hc_UMAP) |> dendro_data()\ndf_clst_Match_UMAP <- tibble(\n  label = dend_Data_UMAP$labels$label,\n  cluster = label_clst_Hclust_UMAP[dend_Data_UMAP$labels$label]\n)\n\n# Join segment → label → cluster\ndf_Segment_Hclst_UMAP <- dend_Data_UMAP$segments %>%\n  left_join(dend_Data_UMAP$labels %>% select(label, x), by = \"x\") %>%\n  left_join(df_clst_Match_UMAP, by = \"label\")\n\n# Fill NA cluster values upward in tree\ndf_Segment_Hclst_UMAP$cluster <- zoo::na.locf(df_Segment_Hclst_UMAP$cluster, fromLast = TRUE)\n\nggplot() +\n  geom_segment(data = df_Segment_Hclst_UMAP,\n               aes(x = x, y = y, xend = xend, yend = yend,\n                   color = factor(cluster)),\n               linewidth = 0.7) +\n  geom_text(data = dend_Data_UMAP$labels,\n            aes(x = x, y = y, label = label),\n            hjust = 1, angle = 90, size = 3) +\n  labs(title = \"Dendrogram (Complete Linkage)\",\n       x = \"\", y = \"Height\", color = \"Cluster\") +\n  theme(axis.text.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        panel.grid = element_blank())\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-22-1.png){width=864}\n:::\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\ndf_Hclust_Plot_UMAP <- cbind(df_Clust_Plot_UMAP, clst_Hclust_UMAP)\n# Scatter plot: UMAP1 vs UMAP2\ngp_Hclust1_UMAP <- ggplot(df_Hclust_Plot_UMAP, aes(x = UMAP2, y = UMAP1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_mark_ellipse(aes(x = UMAP2, y = UMAP1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"UMAP2\", y = \"UMAP1\")\n\n# Scatter plot: UMAP1 vs UMAP3\ngp_Hclust2_UMAP <- ggplot(df_Hclust_Plot_UMAP, aes(x = UMAP3, y = UMAP1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_mark_ellipse(aes(x = UMAP3, y = UMAP1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"UMAP3\", y = \"UMAP1\")\ngp_Hclust1_UMAP + (gp_Hclust2_UMAP + theme(axis.text.y = element_blank(),\n                                 axis.title.y = element_blank())) + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-23-1.png){width=864}\n:::\n:::\n\n\n\n\n\n# K-Means\n\n\n## k test\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_Kmeans_Elbow_UMAP <- tibble(k = 2:8, wss_value = NA)\ndf_Kmeans_Silhouette_UMAP <- tibble(\n  k = 2:8, \n  avg_silhouette = NA\n)\n\nfor (i in 2:8) {\n  set.seed(666)\n  fit_Temp <- workflow() |>\n    add_recipe(rcp_Clust_UMAP) |>\n    add_model(k_means(num_clusters = i) |> set_engine(\"stats\")) |>\n    fit(data = df_Clust_Substance)\n  \n  df_Kmeans_Elbow_UMAP$wss_value[df_Kmeans_Elbow$k == i] <- fit_Temp |> \n    extract_fit_engine() |> \n    pluck(\"tot.withinss\")\n  \n\n  clusters <- fit_Temp |> extract_cluster_assignment()\n  # Prepare UMAPA data\n  \n  # Calculate silhouette scores\n  sil <- cluster::silhouette(as.numeric(clusters$.cluster), dist(df_Clust_UMAP))\n  \n  # Store average silhouette width\n  df_Kmeans_Silhouette_UMAP$avg_silhouette[df_Kmeans_Silhouette$k == i] <- \n    mean(sil[, 3])\n  \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot elbow curve\nggplot(df_Kmeans_Elbow_UMAP, aes(x = k, y = wss_value)) +\n  geom_line(color = color_RUB_blue) +\n  geom_point(color = color_RUB_green) +\n  labs(title = \"Elbow Method\", \n       x = \"Number of Clusters (k)\", \n       y = \"Inertia (Within-Cluster Sum of Squares)\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df_Kmeans_Silhouette_UMAP, aes(x = k, y = avg_silhouette)) +\n  geom_line(color = color_RUB_blue) +\n  geom_point(color = color_RUB_green) +\n  labs(\n    title = \"Average Silhouette Score\",\n    x = \"Number of Clusters (k)\",\n    y = \"Average Silhouette Width\"\n  )\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model specification\nmdl_Kmeans <- k_means(num_clusters = 4)\n\n# Workflow\nwflow_Kmeans <- workflow() |>\n  add_recipe(rcp_Clust_UMAP) |>\n  add_model(mdl_Kmeans)\n\n# Fit the model\nfit_Kmeans_UMAP <- fit(wflow_Kmeans, data = df_Clust_Substance)\nfit_Kmeans_UMAP$fit\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$actions\n$actions$model\n$spec\nK Means Cluster Specification (partition)\n\nMain Arguments:\n  num_clusters = 4\n\nComputational engine: stats \n\n\n$formula\nNULL\n\nattr(,\"class\")\n[1] \"action_model\" \"action_fit\"   \"action\"      \n\n\n$fit\ntidyclust cluster object\n\nK-means clustering with 4 clusters of sizes 3, 4, 4, 5\n\nCluster means:\n       UMAP1      UMAP2      UMAP3\n3 -1.1843612  0.1698604  0.9132638\n1 -0.1933817 -0.6562004 -1.1678360\n4  0.9746621 -0.7275874  0.2550662\n2  0.3135469  0.9582541  0.3832226\n\nClustering vector:\n [1] 1 2 3 3 4 2 3 3 2 4 2 4 4 1 1 4\n\nWithin cluster sum of squares by cluster:\n[1] 1.830289 3.343100 3.324157 5.521436\n (between_SS / total_SS =  64.9 %)\n\nAvailable components:\n\n[1] \"cluster\"      \"centers\"      \"totss\"        \"withinss\"     \"tot.withinss\"\n[6] \"betweenss\"    \"size\"         \"iter\"         \"ifault\"      \n\nattr(,\"class\")\n[1] \"stage_fit\" \"stage\"    \n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract cluster assignments\nclst_Kmeans_UMAP <- fit_Kmeans_UMAP |>\n  extract_cluster_assignment()\nclst_Kmeans_Centroids_UMAP <- fit_Kmeans_UMAP |> extract_centroids()\n```\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\ndf_Kmeans_Plot_UMAP <- cbind(df_Clust_Plot_UMAP, clst_Kmeans_UMAP)\n# Scatter plot: UMAP1 vs UMAP2\ngp_Kmeans1_UMAP <- ggplot(df_Kmeans_Plot_UMAP, aes(x = UMAP2, y = UMAP1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_point(data = clst_Kmeans_Centroids_UMAP, \n             aes(x = UMAP2, y = UMAP1, color = .cluster), \n             shape = \"X\", size = 4) +\n  geom_mark_ellipse(aes(x = UMAP2, y = UMAP1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"UMAP2\", y = \"UMAP1\")\n\n# Scatter plot: UMAP1 vs UMAP3\ngp_Kmeans2_UMAP <- ggplot(df_Kmeans_Plot_UMAP, aes(x = UMAP3, y = UMAP1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_point(data = clst_Kmeans_Centroids_UMAP, \n             aes(x = UMAP3, y = UMAP1, color = .cluster), \n             shape = \"X\", size = 4) +\n  geom_mark_ellipse(aes(x = UMAP3, y = UMAP1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"UMAP3\", y = \"UMAP1\")\ngp_Kmeans1_UMAP + (gp_Kmeans2_UMAP + theme(axis.text.y = element_blank(),\n                                 axis.title.y = element_blank())) + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-28-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n# DBSCAN\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# dbscan -----------\nfit_DBSCAN_UMAP <- dbscan(df_Clust_UMAP, eps = 1.3, minPts = 3)\nclst_DBSCAN_UMAP <- paste0(\"Cluster_\", fit_DBSCAN_UMAP$cluster)\nclst_DBSCAN_UMAP[clst_DBSCAN_UMAP == \"Cluster_0\"] <- NA\n```\n:::\n\n::: {.cell fig-fullwidth='true'}\n\n```{.r .cell-code}\ndf_DBSCAN_Plot_UMAP <- cbind(df_Clust_Plot_UMAP, .cluster = clst_DBSCAN_UMAP)\n# Scatter plot: UMAP1 vs UMAP2\ngp_DBSCAN1_UMAP <- ggplot(df_DBSCAN_Plot_UMAP, aes(x = UMAP2, y = UMAP1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_mark_ellipse(aes(x = UMAP2, y = UMAP1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"UMAP2\", y = \"UMAP1\")\n\n# Scatter plot: UMAP1 vs UMAP3\ngp_DBSCAN2_UMAP <- ggplot(df_DBSCAN_Plot_UMAP, aes(x = UMAP3, y = UMAP1, color = .cluster, shape = substance)) +\n  geom_point(size = 2) +\n  scale_shape_manual(values = 1:length(unique(df_Clust_Plot_UMAP$substance))) +\n  geom_mark_ellipse(aes(x = UMAP3, y = UMAP1, group = .cluster), alpha = 0.2, show.legend = FALSE) +\n  labs(x = \"UMAP3\", y = \"UMAP1\")\ngp_DBSCAN1_UMAP + (gp_DBSCAN2_UMAP + theme(axis.text.y = element_blank(),\n                                 axis.title.y = element_blank())) + plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-30-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n# Consensus Matrix -- Co-clustering of substances\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmat_Clust <- as.matrix(df_Clust_Normal)\nint_K <- 4\nn_Obsevation <- nrow(mat_Clust)\nmat_Consensus <- matrix(0, n_Obsevation, n_Obsevation)\nn_Run <- 100\nfor (i_Run in 1:n_Run) {\n  # you can choose any clustering algorithm (kmeans, pam, hclust)\n  fit <- kmeans(mat_Clust, centers = int_K)\n  clst_Km <- fit$cluster\n  # update mat_Consensus matrix\n  for (i in 1:n_Obsevation) {\n    for (j in 1:n_Obsevation) {\n      if (clst_Km[i] == clst_Km[j]) mat_Consensus[i, j] <- mat_Consensus[i, j] + 1\n    }\n  }\n}\n\n# normalize to 0–1\nmat_Consensus <- mat_Consensus / n_Run\nrownames(mat_Consensus) <- rownames(df_Clust_Normal)\ncolnames(mat_Consensus) <- rownames(df_Clust_Normal)\n# melt matrix\ndf_Consensus_Plot <- melt(mat_Consensus)\ncolnames(df_Consensus_Plot) <- c(\"Substance1\", \"Substance2\", \"Prob\")\n\n# optional: order substances by hierarchical clustering\nhc_Con <- hclust(dist(mat_Consensus))\nidx_Order <- hc_Con$labels[hc_Con$order]\ndf_Consensus_Plot$Substance1 <- factor(df_Consensus_Plot$Substance1, levels = idx_Order)\ndf_Consensus_Plot$Substance2 <- factor(df_Consensus_Plot$Substance2, levels = idx_Order)\n\n# heatmap\nggplot(df_Consensus_Plot, aes(Substance1, Substance2, fill = Prob)) +\n  geom_tile(color = \"grey96\") +\n  scale_fill_gradientn(\"Co-clustering\\nProbability\", colors = color_DRESDEN[-c(1:3)]) +\n  coord_fixed(ratio = 1, expand = FALSE) +\n  theme(axis.title.x = element_blank(),\n        axis.title.y = element_blank(),\n        axis.text.x = element_text(angle = 90, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](ml_clustering_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "ml_clustering_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}